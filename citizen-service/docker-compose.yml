version: '3'
services: 
    app:
        container_name: citizen-service
        build: .
        ports: 
            - '8080:8080'
        restart: on-failure
        environment: 
            AMQP_URL: 'amqp://rabbitmq?connection_attempts=5&retry_delay=5'
        volumes: 
            - api:/usr/src/app/
        depends_on:
            - citizen-mysql
            - rabbitmq
        networks:
            - thesis_network
    
    citizen-mysql:
        image: mysql:5.7
        container_name: citizen_db_mysql
        ports:
            - '3306:3306'
        environment: 
            - MYSQL_ROOT_HOST=${DB_HOST} 
            - MYSQL_USER=${DB_USER}
            - MYSQL_PASSWORD=${DB_PASSWORD}
            - MYSQL_DATABASE=${DB_NAME}
            - MYSQL_ROOT_PASSWORD=${DB_PASSWORD}
        volumes:
            - database_mysql:/var/lib/mysql/
        networks:
            - thesis_network
            
    phpmyadmin:
        image: phpmyadmin/phpmyadmin
        container_name: phpmyadmin_container
        depends_on:
            - citizen-mysql
        environment:
            - PMA_HOST=citizen-mysql # Note the "mysql". Must be the name of the what you used as the mysql service.
            - PMA_USER=${DB_USER}
            - PMA_PORT=${DB_PORT}
            - PMA_PASSWORD=${DB_PASSWORD}
        ports:
            - 9090:80
        restart: always
        networks:
            - thesis_network
    
    rabbitmq:
        image: 'rabbitmq:3.8.2-management'
        container_name: rabbitmq_container 
        ports: 
            - '5672:5672'
            - '15672:15672'
        networks: 
            - thesis_network
volumes: 
    api:
    database_mysql:

networks: 
    thesis_network:
        driver: bridge
